var tick=new Audio;tick.src="new_chat_message.mp3";var chat={hr:0,id_channel:-1,id_to:-1,name_channel:"",timer1:0,data:{lastID:0,noActivity:0},init:function(id_channel,id_to){$("#name").defaultText("Nickname");var working=false;chat.id_channel=id_channel;chat.id_to=id_to;$("#chatSubmitForm").submit(function(){var text=$("#chatText").val();if(text.length==0){return false}if(working)return false;working=true;var tempID="t"+Math.round(Math.random()*1e6),params={id:tempID,direction:"me",author:chat.data.name,text:text};tick.play();if(chat.data.name==0){ohSnap("Человек Без Ника, мы не смогли тебя опознать");return false}chat.addChatLine($.extend({},params),0);$.tzPOST("submitChat",$(this).serialize(),function(r){working=false;$("#chatText").val("");$("div.chat-"+tempID).remove();params["id"]=r.insertID;chat.addChatLine($.extend({},params),0)});$("textarea#chatText").height(20);return false});$.tzGET("checkLogged","id_to="+chat.id_to,function(r){if(r.logged){chat.data.lastID=r.loggedAs.limit_id;chat.login(r.loggedAs.name,r.loggedAs.gravatar,r.name_channel)}});window.addEventListener("scroll",function(){if($(window).scrollTop()==0){$("div#loadmore_top").show();if(chat.timer1){clearTimeout(chat.timer1)}chat.timer1=setTimeout(function(){if($(window).scrollTop()>20)return false;$.tzGET("getChats",{lastID:$("#chatLineHolder .chat:first").prop("id"),id_from:chat.id_to,getold:1},function(r){for(var i=0;i<r.chats.length;i++){chat.addChatLine(r.chats[i],1)}$("div#loadmore_top").hide()})},500)}setRead()},false)},login:function(name,gravatar,name_channel){chat.data.name=name;chat.data.gravatar=gravatar;$("#chatTopBar").html(chat.render("loginTopBar",chat.data));$("h1").text(name_channel);(function getChatsTimeoutFunction(){chat.getChats(getChatsTimeoutFunction)})()},render:function(template,params){var arr=[];switch(template){case"loginTopBar":arr=['<span><img src="',params.gravatar,'" width="23" height="23" />','<span class="name">',params.name];break;case"chatLine":avatar='<div class="left chat_avatar"><img id="avatar" class="small '+(params.gender==1?"fe":"")+'male" src="//app.motohelplist.com/old/avatar_make.php?id_user='+params.id_from+"&name="+params.author+'" width="23" height="23"></div>';var avatarspan='<a role="external" href="profile.php?userprofile='+params.id_from+'&">'+avatar+"</a>";var nickauthor='<div class="chatname '+(params.gender==1?"fe":"")+'male">'+params.author+"</div>";if(!params.id_from)params.id_from=getCookie("id_user");params.text=linkify(params.text.replace(/\n/g,"<br />"));var isI=getCookie("id_user")==params.id_from;arr=['<div id="'+params.id+'" class=" chat '+params.direction+" chat-",params.id," "+(params.id_lines==params.id?"unread":"")+'"> '+(isI?"":avatarspan),'<div class="chattext">'+(isI?"":nickauthor),'<span class="chatline">'+params.text+"</span><br>",'<div class="right '+params.delivered+'"></div><div class="right time-stamp" time="'+params.time+'">',params.timeMoment,"</div></div></div>"];break;case"user":break}return arr.join("")},addChatLine:function(params,getold){if(!params.time){params.time=moment().unix()}if(relativeTime)params.timeMoment=moment.unix(params.time).fromNow();else params.timeMoment=moment.unix(params.time).calendar();doMoment();var chatlineholder=$("#chatLineHolder");var markup=chat.render("chatLine",params),exists=$("#chatLineHolder .chat-"+params.id);if(exists.length){exists.remove()}if(params.id.toString().charAt(0)!="t"){if(getold==1){var previous=$("#chatLineHolder .chat:first")}else var previous=$("#chatLineHolder .chat-"+(+params.id-1));if(previous.length){if(params.id_lines!=null&&chat.hr==0){previous.append('<fieldset id="unread"><legend align="center">Непрочитанные</legend></fieldset>');chat.hr=1}if(getold==0)previous.after(markup);else previous.before(markup)}else chatlineholder.append(markup)}else chatlineholder.append(markup);setRead();if(getold==0)document.body.scrollTop=document.body.scrollHeight},getChats:function(callback){$.tzGET("getChats",{lastID:chat.data.lastID,id_from:chat.id_to},function(r){for(var i=0;i<r.chats.length;i++){chat.addChatLine(r.chats[i],0)}if(r.chats.length){chat.data.noActivity=0;chat.data.lastID=r.chats[i-1].id}else{chat.data.noActivity++}if(!chat.data.lastID){}var nextRequest=1e3;if(chat.data.noActivity>3){nextRequest=2e3}if(chat.data.noActivity>10){nextRequest=5e3}if(chat.data.noActivity>20){nextRequest=15e3}setTimeout(callback,nextRequest)})},getUsers:function(callback){},displayError:function(msg){var elem=$("<div>",{id:"chatErrorMessage",html:msg});elem.click(function(){$(this).fadeOut(function(){$(this).remove()})});setTimeout(function(){elem.click()},5e3);elem.hide().appendTo("body").slideDown()}};$.tzPOST=function(action,data,callback){$.post("onair-ajax.php?channel="+chat.id_channel+"&action="+action,data,callback,"json")};$.tzGET=function(action,data,callback){$.get("onair-ajax.php?channel="+chat.id_channel+"&action="+action,data,callback,"json")};$.fn.defaultText=function(value){var element=this.eq(0);element.data("defaultText",value);element.focus(function(){if(element.val()==value){element.val("").removeClass("defaultText")}}).blur(function(){if(element.val()==""||element.val()==value){element.addClass("defaultText").val(value)}});return element.blur()};function setRead(){$(".unread").each(function(i,elem){if($(elem).visible()){$(elem).removeClass("unread");$.tzPOST("setRead","msgID="+$(elem).prop("id"),function(r){});setTimeout(function(){$("fieldset#unread").hide(animation)},5e3)}})}