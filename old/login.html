<!doctype html>
<!--html lang="ru" manifest="manifest.appcache.php"-->
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimal-ui, user-scalable=no"/>
    
<!-- for ios 7 style, multi-resolution icon of 152x152 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-barstyle" content="black-translucent">
<link rel="apple-touch-icon" href="img/logo_152.png">

<!--splash src="img/Default~iphone.png" width="320" height="480"/>
<splash src="img/Default@2x~iphone.png" width="640" height="960"/-->

<link rel="apple-touch-startup-image" href="img/Default_iphone.png">
<link rel="apple-touch-startup-image" href="img/logo_1024.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)" />
<link rel="apple-touch-startup-image" href="img/logo_1024.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)" />



<!-- for Chrome on Android, multi-resolution icon of 196x196 -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="shortcut icon" sizes="196x196" href="img/logo_196.png">
<link rel="icon" sizes="192x192" href="img/logo_196.png">


    <title>Moto Helplist</title>
    <link rel="stylesheet" href="sass/templates.css"/>
    <link rel="icon" type="image/vnd.microsoft.icon" href="favicon.ico" />     
</head>
<body class="large-3">
<div id="loader"><img src="../img/loader.gif"></div>
<div id="content">
    <form id="login_password" name="login" action="login.php" method="post" onsubmit="validate1();return false;">
        <div class="row">
            <div class="small-12 columns">                
                <h3 class="">Проходите пожалуйста</h3><br>
                <div class="small-3 columns">
                    <span class="prefix">Тел.</span>
                </div>
                <div class="small-1 columns">
                    <span class="prefix"><strong>+</strong></span>
                </div>
                <div class="small-8 columns">
                        <input type="tel" id="phone" name="phone" placeholder="с кодом страны" value="" class="">
                </div>                           
                <div class="small-4 columns">
                    <span class="prefix">Пароль</span>
                </div>
                <div class="small-8 columns">
                        <input type="password" id="passwd" value="" class="">
                </div>                           
                
                <div class="small-12 columns" style="margin-bottom: 10px;">
                    <div id="status" class=" hide"></div>
                    <p id="nopassword" class="subheader">Нет пароля? Придумайте его.</p>
                </div>
                <input type="submit" value="Войти" class="expand round small success button">
                <input type="hidden" id="password" name="password" value="">
            </div>
        </div>                        
    </form>
    <p>&nbsp;</p>
    <p class="small-12 text-center"><a target="_blank" href="manifest.html">Пользовательское соглашение</a></p>
<div id="ohsnap"></div>    
</div>

<script src="/js/jquery.min.js"></script>
<script src="/js/ohsnap.js"></script>    
<script src="js/sha1.js"></script>        
<script src="/js/cookie.js"></script>



<script>
if(window.navigator.standalone == true) 
    console.log('standalone!');
    
    $('#loader').hide();


    /*
    /* узнаем страну юзера из куки
    /* если страна изменилась - выдаем приветствие
    */
    var userCountry = getCookie('currentCountry');
    var setCountry = $.get("//app.motohelplist.com/online.php")
    .success(function() 
    { 
        //console.log('setCountry = '+setCountry.statusText);
        setTimeout(function() { 
            var currentCountry = getCookie('currentCountry'); // нужно повторить, кука изменилась
            getPhoneCode(currentCountry);
            
            // если страна изменилась
            if (userCountry != currentCountry)
            {
                ohSnap('Welcome to '+currentCountry.toUpperCase());
            }            
         }, 500);
    })
    .error(function() { 
        //console.log('setCountry = '+setCountry.statusText);
        ohSnap('Кажется, интернет тормозит...');
    })    
    
    
    
    /*
    /* подтянем первую цифру кода страны в поле "тел"
    /* вставим ее только если поле "тел" пустое, иначе не трогаем
    /* иначе не будет работать восстановление пароля
    */
    function getPhoneCode(currentCountry)
    {
        if ( document.getElementById('phone').value == '' && currentCountry) 
        {    
            var phone = localStorage.getItem('phone');
            var sessionid = localStorage.getItem('sessionid');
            var registered = parseInt(localStorage.getItem('registered'));
            document.getElementById('phone').value = phone;
            if (sessionid && registered == 1)
            {
                document.getElementById('passwd').value = sessionid;   
                validate1();
            }

                var jqxhr = $.get("search.php?data=phoneCode&term="+currentCountry) 
                .success(function(data) {

                    var phoneCode = JSON.parse(data)[0]['phone_code'];
                    if (!phone)
                    {
                        document.getElementById('phone').value = phoneCode;
                    }
                    (phoneCode == 'undefined' ?  window.phoneCode = '' : window.phoneCode = phoneCode);
                    ohSnap('Сэр, я не узнаю Вас в гриме...');
                });
            
        }    
    }




    /*
    /* проверка и отправка формы
    */
    function validate1()
    {
        document.getElementById('status').className = 'hide'
        
        if ( document.getElementById('phone').value.replace(/[^\d,]/g, '').length < 11 )
        {
            document.getElementById('status').innerText = 'Кажется, в номере чего-то не хватает...';
            document.getElementById('status').className = '';
        }
        
        else if ( document.getElementById('passwd').value.length == '' )
        {
            document.getElementById('status').innerText = 'Пароль не может быть пустым';
            document.getElementById('status').className = '';
        }
        else 
        {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('password').value = sha1(document.getElementById('passwd').value);
            if (document.getElementById('phone').value != '') localStorage.setItem('phone',document.getElementById('phone').value);
            localStorage.setItem('sessionid',document.getElementById('passwd').value);
            document.getElementById('login_password').submit();
        }
        return false;
    }



    // начальные установки
    if (!localStorage.getItem('animation')) localStorage.setItem('animation',300);
    if (!localStorage.getItem('sosAirOnly')) localStorage.setItem('sosAirOnly',0);
    if (!localStorage.getItem('geocodeAddr')) localStorage.setItem('geocodeAddr', 0);
    if (!localStorage.getItem('initZoom')) localStorage.setItem('initZoom', 14);
    if (!localStorage.getItem('initLat')) localStorage.setItem('initLat', '53.1424223');
    if (!localStorage.getItem('initLng')) localStorage.setItem('initLng', '29.2242762');  
    if (!localStorage.getItem('relativeTime')) localStorage.setItem('relativeTime', 1);  
    if (!localStorage.getItem('minimumClusterSize')) localStorage.setItem('minimumClusterSize', 2);  
    if (!localStorage.getItem('showTrafficLayer')) localStorage.setItem('showTrafficLayer', 0);
    if (!localStorage.getItem('registered')) localStorage.setItem('registered', '0');
    
    
</script>

</body>
</html>
