var scrollTimeout=0;var allowScrollMessages=1;myApp.onPageInit("messages",function(page){oldPhotos=photoBrowser.params.photos;photoBrowser.params.photos=[];var messages=[];myMessages=myApp.messages(".messages",{messages:messages,autoLayout:true,messageTemplate:'<div data-message-id="{{id}}" class="message message-{{type}} {{#js_compare "parseInt(this.unread)===1"}}unread{{/js_compare}} {{#if hasImage}}message-pic{{/if}} {{#if avatar}}message-with-avatar{{/if}} {{#if position}}message-appear-from-{{position}}{{/if}}">'+'<div class="message-name {{#js_compare "parseInt(this.gender)===1"}}fe{{/js_compare}}male" onclick="getProfile({{id_from}})">{{name}}</div>'+'<div class="message-text">{{text}}{{#if ts}}<div class="message-date" time="{{ts}}"></div>{{/if}}</div>'+'{{#if avatar}}<div class="message-avatar" style="background-image:url({{avatar}})" onclick="getProfile({{id_from}})"></div>{{/if}}'+'{{#if label}}<div class="message-label">{{label}}</div>{{/if}}'+"</div>"});$$("#chat-attach").on("change",function(e){var messagePic=document.getElementById("chat-attach").files[0];var imageType=/^image\//;if(messagePic&&imageType.test(messagePic.type)){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var img=document.createElement("img");img.src=window.URL.createObjectURL(messagePic);img.className="message messagePic right";img.onload=function(){var MAX_WIDTH=960;var MAX_HEIGHT=1280;var width=img.width;var height=img.height;if(width>MAX_WIDTH||height>MAX_HEIGHT){if(width>height){height*=MAX_WIDTH/width;width=MAX_WIDTH}else{width*=MAX_HEIGHT/height;height=MAX_HEIGHT}}$$(".messagesHolder").append('<canvas id="messagePicCanvas" width="'+width+'" height="'+height+'">Превью невозможно: устройство не поддерживает нужные технологии.</canvas>');var ctx=messagePicCanvas.getContext("2d");var hRatio=messagePicCanvas.width/img.width;var vRatio=messagePicCanvas.height/img.height;var ratio=Math.min(hRatio,vRatio);messagePicCanvas.width=(img.width*ratio).toFixed();messagePicCanvas.height=(img.height*ratio).toFixed();ctx.drawImage(img,0,0,img.width,img.height,0,0,(img.width*ratio).toFixed(),(img.height*ratio).toFixed());var dataurl=messagePicCanvas.toDataURL("image/jpeg",.6);var id_channel=$$('.page[data-page="messages"]').dataset().id_channel;var id_to=$$('.page[data-page="messages"]').dataset().id_from;myApp.showProgressbar();var dataurl=dataURItoBlob(dataurl);var xhr=$$.ajax({url:API_URL+"img/"+id_channel+"/"+id_to,type:"POST",dataType:"json",data:dataurl,success:function(response){console.log("картинка загружена",response);myApp.hideProgressbar();$$(messagePicCanvas).detach();photoBrowser.params.photos.push(response.text);myMessages.appendMessage({text:'<img data-src="'+response.text+'" class="lazy-fadeIn lazy-loaded" src="'+response.text+'" onclick="photoBrowser.open('+photoBrowser.params.photos.length+')">',type:"sent",ts:(moment.now()/1e3-1).toFixed()},animateChats)},error:function(error){console.log("ошибка загрузки картинки в чат",error);myApp.hideProgressbar()}})};setTimeout(function(){myMessages.scrollMessages()},100)}else{myApp.alert("Загрузка файлов не поддерживается этим устройством")}}});var myMessagebar=myApp.messagebar(".messagebar");$$(".messagebar a.send-message").on("click",function(e){$$(".messagebar a.send-message").addClass("disabled");var messageText=myMessagebar.value();if(messageText.length===0){$$(".messagebar a.send-message").removeClass("disabled");return}if(page.container.dataset.id_channel==0)var url="users/"+page.container.dataset.id_from+"/messages";else var url="channels/"+page.container.dataset.id_channel+"/messages";myApp.showProgressbar();$$.ajax({method:"POST",url:API_URL+url,data:JSON.stringify({message:messageText}),success:function(response){myMessagebar.clear();$$(".messagebar a.send-message").removeClass("disabled");myMessages.appendMessage({text:messageText,type:"sent",ts:(moment.now()/1e3-1).toFixed()},animateChats);tick.play();doMoment();myApp.hideProgressbar();data=JSON.parse(response);db.transaction(function(tx){tx.executeSql("INSERT OR REPLACE INTO messages (id, id_channel, id_from, id_to, text, ts, name, gender, unread) values(?,?,?,?,?,?,?,?,?);",[data[0].id,data[0].id_channel,data[0].id_from,data[0].id_to?data[0].id_to:0,data[0].text,data[0].ts,myApp.formGetData("profile").name,myApp.formGetData("profile").gender,0])})},error:function(response){myApp.hideProgressbar();myApp.addNotification({title:"Кажется, нет интернета...",text:"Давай попробуем позже.",hold:4e3});console.log("addMessage error",response);if(response.status==404){myApp.alert('Канал не существует. Нажми "Выход" и зайди снова для обновления списка каналов.')}}})});$$(".page").on("scroll",function(){checkRead()},true);$$(".messages-content.infinite-scroll").on("infinite",function(){myApp.detachInfiniteScroll($$(".messages-content.infinite-scroll"));$$(".preloader-top").show();if($$(".messages .message:first-child").dataset())fillMessages(page.container.dataset.id_channel,$$(".messages .message:first-child").dataset().messageId,page.container.dataset.id_from,itemsPerLoad)});fillMessages(page.container.dataset.id_channel,0,page.container.dataset.id_from,20);setTimeout(function(){myMessages.scrollMessages()},100);$$("a.open-channelinfo").on("click",function(){getChannelInfo(page.container.dataset.id_channel)})});function getChannelInfo(id_channel){myApp.showPreloader();var channelInfo=new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",API_URL+"channels/"+id_channel+"/info");xhr.setRequestHeader("x-access-token",myApp.ls.getItem("token"));xhr.onload=function(){if(this.status==200){resolve(this.response)}else{var error=new Error(this.statusText);error.code=this.status;reject(error)}};xhr.onerror=function(){reject(new Error("Network Error"));myApp.hidePreloader();myApp.alert("Кажется нет интернета... Давай попробуем позднее.");return};myApp.mainView.loadPage("channel_info.html");xhr.send()});channelInfo.then(function(response){var response=JSON.parse(response);var channelname=response.name;var channelcount=response.count+" участников";if(response.name)$$(".channelname").text(channelname);$$(".channelcount").text(channelcount);var members=response.members;var html=Template7.templates.channelmembers({members:members});$$("#membersResults").html("").append(html);if(response.owner&&parseInt(response.owner)==parseInt(myIdUser)){$$(".formoder").removeClass("hide")}else{$$("#membersResults .swipeout-actions-right").detach()}myApp.hidePreloader()})}function fillMessages(channel,lastid,id_from,itemsPerLoad){var promise=new Promise(function(resolve,reject){var messages=[];db.readTransaction(function(tx){var order="DESC";var dbfilter=lastid==0?"":"and id < "+lastid;var url="";if(channel==0){url="users/"+id_from+"/messages";dbfilter=dbfilter+" and ((id_from = "+id_from+" and id_to="+myIdUser+") or (id_to ="+id_from+" and id_from="+myIdUser+"))"}else url="channels/"+channel+"/messages";var query="SELECT * from ( SELECT id, id_from, gender, name, text, ts, COALESCE(unread,0) as unread FROM messages WHERE id_channel = "+channel+" "+dbfilter+" order by ts DESC LIMIT 0,"+itemsPerLoad+") t1 ORDER BY t1.ts "+order;tx.executeSql(query,[],function(tx,result){for(var i=0;i<result.rows.length;i++){messages.push(result.rows.item(i))}{resolve(new Promise(function(resolve,reject){var filter=lastid==0?"?":"?filter=id less "+lastid+"&";$$.ajax({method:"GET",url:API_URL+url+filter+"results="+itemsPerLoad+"&order="+order,success:function(response){try{messages=JSON.parse(response)}catch(e){console.log(e)}writeMessages(JSON.parse(response),channel);resolve(messages)},error:function(response){console.log("Сервер упал? Канал удален? ");resolve(messages)}})}))}})})});promise.then(function(messages){$$.each(messages,function(i){var message={};message.id=messages[i].id;message.id_from=messages[i].id_from;message.gender=messages[i].gender;message.gender=messages[i].gender;if(parseInt(messages[i].id_from)==parseInt(myIdUser)){message.type="sent"}else{message.type="received";message.name=messages[i].name;message.avatar="//app.motohelplist.com/img/avatar/"+messages[i].id_from+".jpg"}try{message.text=linkify(messages[i].text).replace(/\n/g,"<br>")}catch(err){console.error("похоже юзер написал какую-то хуйню и linkify не может ее обработать",err.message);console.log("хуйня была такая: ",messages[i].text,messages[i].text.length)}message.ts=messages[i].ts;message.unread=messages[i].unread;myMessages.prependMessage(message,false)});if(messages.length>0)myApp.attachInfiniteScroll($$(".infinite-scroll"));else $$(".preloader-top").hide();checkRead();doMoment();document.body.addEventListener("touchstart",function(event){allowScrollMessages=0},false);document.body.addEventListener("touchend",function(event){allowScrollMessages=1},false);if($$("#bottomPageMark").offset().top-window.innerHeight<window.innerHeight)allowScrollMessages=1;else allowScrollMessages=0;if(allowScrollMessages==1)setTimeout(function(){myMessages.scrollMessages()},100);$$(".linkmap").on("click",function(e){console.log("e",e.target.dataset.lat,e.target.dataset.lng);console.log("грузим координаты "+"map.html?lat="+e.target.dataset.lat+"&lng="+e.target.dataset.lng);myApp.mainView.loadPage("map.html?lat="+e.target.dataset.lat+"&lng="+e.target.dataset.lng)})})}function writeMessages(data,channel){$$.each(data,function(i){db.transaction(function(tx){if(channel)data[i].id_channel=channel;tx.executeSql("INSERT OR REPLACE INTO messages (id, id_channel, id_from, id_to, text, ts, name, gender, unread) values(?,?,?,?,?,?,?,?,?);",[data[i].id,data[i].id_channel,data[i].id_from,data[i].id_to?data[i].id_to:0,data[i].text,data[i].ts,data[i].name,data[i].gender,data[i].unread],function(tx,results){},function(tx,error){console.log("writeMessages Error ",error,query)})})})}function getChannelMessages(id_channel,channel_name,id_from,type_channel){var newPageContent='<div class="navbar"><div class="navbar-inner"><div class="left"><a href="#" class="back link icon-only"><i class="icon icon-back"></i></a></div><div class="center sliding">'+channel_name+'</div><div class="right">';if(id_channel>0&&type_channel==3){newPageContent=newPageContent+'<a href="#" class="open-channelinfo"><i class="icon icon-settings"></i></a>'}newPageContent=newPageContent+'<a href="#" class="link icon-only open-panel"><i class="icon icon-bars"></i></a></div></div></div>'+'<div class="pages"><div class="page" data-page="messages" data-id_channel="'+id_channel+'" data-id_from="'+id_from+'">'+'<div class="toolbar messagebar">'+'<div class="toolbar-inner"><i class="icon icon-camera"></i>'+'<span class="fileinput-button" data-role="button" data-icon="plus"><input id="chat-attach" type="file" accept="image/*" id="capture"></span>'+'<textarea placeholder="Ответ"></textarea><a href="#" class="link send-message">Send</a>'+"</div>"+"</div>"+'<div class="page-content hide-bars-on-scroll messages-content infinite-scroll infinite-scroll-top"><div class="preloader-top"><div class="preloader"></div></div>'+'<div class="messagesHolder" data-distance="50"><div class="messages"></div></div><span id="bottomPageMark"></span>'+"</div>"+"</div>";mainView.router.loadContent(newPageContent)}function checkRead(){if(scrollTimeout>0)return;scrollTimeout=1;setTimeout(function(){unread=$$(".message.unread");$$.each(unread,function(i){if($$(unread[i]).offset().top-window.innerHeight<-100){$$(unread[i]).removeClass("unread");var messageId=$$(unread[i]).dataset().messageId;var pageData=$$(myApp.getCurrentView().activePage.container).dataset();if(pageData.id_channel==0)var idBadge="#UnreadMsg-"+pageData.id_from;else var idBadge="#UnreadMsg-"+pageData.id_channel;var unreadTotal=parseInt($$(idBadge))-1;unreadTotal<=0?$$(idBadge).text(unreadTotal):$$(idBadge).hide();$$.ajax({method:"PUT",url:API_URL+"messages/"+messageId+"/read",success:function(response){}});db.transaction(function(tx){var query="UPDATE messages set unread =0 where id = "+$$(unread[i]).dataset().messageId;tx.executeSql(query,[],function(tx,results){},function(tx,error){console.log("writeMessages Error ",error,query)})})}});scrollTimeout=0},2e3)}function dataURItoBlob(dataURI){var byteString;if(dataURI.split(",")[0].indexOf("base64")>=0)byteString=atob(dataURI.split(",")[1]);else byteString=unescape(dataURI.split(",")[1]);var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}return new Blob([ia],{type:mimeString})}