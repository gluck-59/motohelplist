


function updateHelplist() 
{
    ids = Array();
    
    function find(data, value) 
    {
        if (data.indexOf) { // если метод существует
            return data.indexOf(value);
        }
        for (var i = 0; i < data.length; i++) 
        {
            if (data[i] === value) return i;
        }
        return -1;
    }

    if (!window.openDatabase) {
        return false;
    }
/*    
    lastupdate = localStorage.getItem('helplist_updated');
    if (lastupdate)
        request = '?lastupdate='+lastupdate;
    else request = '';      
*/
request = '';
    var jqxhr = $.get("https://app.motohelplist.com/helplist.php"+request)
    .success(function(data) 
    {
        data = $.parseJSON(data);
if (window.openDatabase) {
        var dbsize = 5 * 1024 * 1024; // 5mb initial database
        db = openDatabase("motokofr_motohelplistq", 1, "", dbsize);
            db.transaction(function (tx) 
            {
                tx.executeSql('CREATE TABLE IF NOT EXISTS helplist (id_user, name, city_name, phone, help_repair,help_garage, help_food, help_bed, help_beer, help_strong, help_party, help_excursion, description, gender, date_last_login, lat, lng)');

            });
        
        
}

            db.transaction(function (tx) 
            {

//************* на самом деле date_last_login  это не date_last_login, а date_add - дата регистрации юзера */
//************* потому что last login в хелплисте неактуальный, а знать насколько "старый" юзер - это полезно */

                    var query = 'SELECT id_user from helplist';
                    tx.executeSql(query,[], function(tx, result) {
                        for(var i = 0; i < result.rows.length; i++) {
                          ids.push(result.rows.item(i).id_user);
                        }
                    });
            });
        
            $.each(data, function(i) 
            {
                db.transaction(function (tx) 
                {
                    if (find(ids,parseInt(data[i].id_user))!=-1) 
                       var query = 'UPDATE helplist SET name=\''+data[i].name+'\',city_name=\''+data[i].city_name+'\',phone=\''+data[i].phone+'\',help_repair='+data[i].help_repair+',help_garage='+data[i].help_garage+',help_food='+data[i].help_food+',help_bed='+data[i].help_bed+',help_beer='+data[i].help_beer+',help_strong='+data[i].help_strong+',help_party='+data[i].help_party+',help_excursion='+data[i].help_excursion+',description=\''+data[i].description+'\',gender='+data[i].gender+',date_last_login=\''+data[i].date_add+'\',lat='+data[i].lat+',lng='+data[i].lng+' WHERE id_user='+data[i].id_user;
                       else
                           var query = 'INSERT INTO helplist (id_user, name, city_name, phone, help_repair, help_garage, help_food, help_bed, help_beer, help_strong, help_party, help_excursion, description, gender, date_last_login, lat, lng) VALUES ('+data[i].id_user+',\''+data[i].name+'\',\''+data[i].city_name+'\',\''+data[i].phone+'\','+data[i].help_repair+','+data[i].help_garage+','+data[i].help_food+','+data[i].help_bed+','+data[i].help_beer+','+data[i].help_strong+','+data[i].help_party+','+data[i].help_excursion+',\''+data[i].description+'\','+data[i].gender+',\''+data[i].date_add+'\','+data[i].lat+','+data[i].lng+')';
                    tx.executeSql(query);
//console.log('helplist inserted');
                });
            });
//        localStorage.setItem('helplist_updated', new Date().toJSON());
    });
}